<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ELS HMI - Turning Focus (Modified)</title>
    <style>
      :root {
        /* Palette: Industrial Yellow & Charcoal - Harmonized */
        --body-bg: #222222;
        --screen-bg: #1a1a1a;
        --tab-bar-bg: #101010;
        --content-block-bg: #2d2d2d;
        --content-dot-pattern-color: #454545;

        --text-primary: #f0f0f0;
        --text-secondary: #a0a0a0;
        --text-on-accent: #1a1a1a; /* Dark text on yellow accent */
        --text-on-indicator-light-bg: #1a1a1a; /* Dark text for light/bright indicator BGs (like Orange) */
        --text-on-indicator-dark-bg: #ffffff; /* White text for dark indicator BGs (like Green/Red/Blue) */
        --text-on-active-tab: var(--text-on-accent);

        --accent-primary: #ffcc00; /* Strong Industrial Yellow */
        --accent-primary-lighter-for-gradient: #ffda47;
        --accent-secondary: #555555;

        --button-bg-default: #3d3d3d;
        --button-text-default: var(--text-primary);
        --button-bg-hover: #4d4d4d;
        --button-border-default: var(--accent-secondary);
        --button-border-highlight-top: rgba(255, 255, 255, 0.07);

        --toggle-button-inactive-bg: var(--button-bg-default);
        --toggle-button-inactive-text: var(--button-text-default);
        --toggle-button-active-bg: var(--accent-primary);
        --toggle-button-active-text: var(--text-on-accent);
        --toggle-button-active-border: #e6b800; /* Darker Yellow */

        --dro-bg: #0f0f0f;
        --dro-text-z: #66ff66;
        --dro-text-rpm: var(--accent-primary);

        --indicator-green-bg: #28a745;
        --indicator-red-bg: #dc3545;
        --indicator-blue-bg: var(
          --accent-primary
        ); /* "Set" buttons, Active Direction use primary Yellow */
        --indicator-jog-bg: #ffa500; /* Orange for Jog */

        --status-manual-bg: var(
          --button-bg-hover
        ); /* Darker Grey for Manual status BG */
        --status-manual-text-color: var(
          --accent-primary
        ); /* Yellow text for Manual status */
        --status-semiauto-bg: var(--indicator-green-bg);
        --status-jog-bg: var(--indicator-jog-bg);

        --border-color-medium: var(--accent-secondary);
        --border-color-dark: #333333;
        --active-glow-color: rgba(255, 204, 0, 0.6);

        --shadow-color-soft: rgba(0, 0, 0, 0.2);
        --shadow-color-medium: rgba(0, 0, 0, 0.3);
        --shadow-color-dark: rgba(0, 0, 0, 0.4);
        --shadow-screen: 0 5px 25px rgba(0, 0, 0, 0.5);
        --shadow-button: 0 2px 4px var(--shadow-color-soft);
        --shadow-button-hover: 0 4px 8px var(--shadow-color-medium);
        --shadow-button-active: inset 0 2px 4px var(--shadow-color-medium);
        --shadow-dro-inset: inset 0 1px 3px var(--shadow-color-dark);
        --shadow-toggle-active-inset: inset 0 1px 3px rgba(0, 0, 0, 0.3);

        --gradient-button-subtle: linear-gradient(
          to bottom,
          rgba(255, 255, 255, 0.05) 0%,
          rgba(255, 255, 255, 0) 100%
        );
        --gradient-action-button: linear-gradient(
          to bottom,
          rgba(255, 255, 255, 0.1) 0%,
          rgba(0, 0, 0, 0.1) 100%
        );
        --gradient-accent-button: linear-gradient(
          to bottom,
          var(--accent-primary-lighter-for-gradient) 0%,
          var(--accent-primary) 100%
        );
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--body-bg);
        color: var(--text-primary);
        margin: 0;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        overflow: hidden;
      }
      .screen-container {
        width: 1024px;
        height: 600px;
        background-color: var(--screen-bg);
        display: flex;
        flex-direction: column;
        border-radius: 10px;
        box-shadow: var(--shadow-screen);
        overflow: hidden;
        position: relative;
        flex-shrink: 0;
      }
      .tabs {
        display: flex;
        background-color: var(--tab-bar-bg);
        padding: 4px 6px;
        flex-shrink: 0;
        border-bottom: 1px solid var(--border-color-dark);
      }
      .tab-button {
        flex-grow: 1;
        padding: 12px 10px;
        margin: 4px;
        border: 1px solid transparent;
        border-bottom: none;
        border-radius: 6px 6px 0 0;
        font-size: 20px;
        background-color: var(--toggle-button-inactive-bg);
        color: var(--toggle-button-inactive-text);
        transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        text-align: center;
      }
      .tab-button.active {
        background-color: var(--accent-primary);
        background-image: var(--gradient-accent-button);
        color: var(--text-on-active-tab);
        border-color: var(--toggle-button-active-border);
        font-weight: bold;
        box-shadow: var(--shadow-toggle-active-inset);
        cursor: default;
      }

      .content-area {
        flex-grow: 1;
        padding: 15px;
        display: grid;
        grid-template-columns: 1fr 1.5fr 1fr;
        gap: 15px;
        background-image: radial-gradient(
          circle,
          var(--content-dot-pattern-color) 1px,
          transparent 1px
        );
        background-size: 18px 18px;
        overflow: hidden;
      }
      .content-block {
        background-color: var(--content-block-bg);
        border-radius: 8px;
        padding: 12px;
        box-shadow: inset 0 1px 2px var(--shadow-color-dark);
        display: flex;
        flex-direction: column;
        overflow-y: auto;
      }
      .block-title {
        font-size: 21px;
        font-weight: 600;
        color: var(--accent-primary);
        margin-bottom: 10px;
        padding-bottom: 6px;
        border-bottom: 1px solid var(--border-color-dark);
        text-align: center;
        flex-shrink: 0;
      }
      .column-position-speed {
        grid-column: 1;
      }
      .column-feed-mode {
        grid-column: 2;
      }
      .column-controls {
        grid-column: 3;
      }

      .dro-display {
        background-color: var(--dro-bg);
        font-family: "Consolas", "Courier New", monospace;
        font-size: 56px;
        font-weight: bold;
        padding: 10px 12px;
        border-radius: 6px;
        text-align: right;
        margin-bottom: 8px;
        border: 1px solid var(--border-color-dark);
        min-height: 64px;
        height: 64px;
        line-height: 64px;
        flex-shrink: 0;
        box-shadow: var(--shadow-dro-inset);
        color: var(--text-primary);
      }
      #rpm-display {
        color: var(--dro-text-rpm);
      }
      #z-axis-display {
        color: var(--dro-text-z);
      }

      .dro-label,
      .control-group label {
        font-size: 20px;
        color: var(--text-secondary);
        margin-bottom: 5px;
        flex-shrink: 0;
        display: block;
      }
      .rpm-display-container {
        margin-bottom: 12px;
      }

      /* MODIFIED: .info-note styling for soft transparent yellow and bold, bright text */
      .info-note {
        text-align: center;
        padding: 10px 12px;
        margin-top: 12px;
        border-radius: 6px;
        background-color: rgba(
          255,
          204,
          0,
          0.25
        ); /* Soft transparent yellow (accent-primary at 25% opacity) */
        border: 1px solid var(--accent-primary); /* Brighter yellow border to define the transparent area */
        box-shadow: 0 1px 3px var(--shadow-color-soft); /* A subtle shadow */
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .info-note-label {
        font-size: 16px;
        font-weight: 700; /* Bold */
        color: var(--accent-primary); /* Solid yellow for "NOTE" */
        margin-bottom: 6px;
        text-transform: uppercase;
      }
      .info-note-content {
        font-size: 15px;
        color: var(
          --text-primary
        ); /* Bright text for readability on the darkish transparent BG */
        font-weight: 700; /* Bold text as requested */
        line-height: 1.4;
        max-width: 95%;
      }

      .button,
      .toggle-button,
      input[type="number"] {
        padding: 10px;
        margin: 6px 0;
        border-radius: 5px;
        border: 1px solid var(--button-border-default);
        border-top-color: var(--button-border-highlight-top);
        background-color: var(--button-bg-default);
        background-image: var(--gradient-button-subtle);
        color: var(--button-text-default);
        font-size: 18px;
        cursor: pointer;
        text-align: center;
        box-sizing: border-box;
        transition: background-color 0.15s, box-shadow 0.15s, filter 0.15s,
          transform 0.1s;
        flex-shrink: 0;
        width: 100%;
        box-shadow: var(--shadow-button);
      }
      input[type="number"] {
        color: var(--text-primary);
        background-color: var(--dro-bg);
        background-image: none;
        padding: 10px 8px;
        box-shadow: var(--shadow-dro-inset);
        font-size: 18px;
      }
      .button:hover,
      .toggle-button:not(.active):hover,
      input[type="number"]:hover {
        background-color: var(--button-bg-hover);
        box-shadow: var(--shadow-button-hover), 0 0 8px var(--active-glow-color);
      }
      .button:active,
      .toggle-button:active {
        background-color: var(--button-bg-default);
        filter: brightness(0.9);
        box-shadow: var(--shadow-button-active);
        transform: translateY(1px);
      }
      .control-group > .button,
      .control-group > input[type="number"] {
        width: 100%;
      }
      .control-group {
        margin-bottom: 10px;
        display: flex;
        flex-direction: column;
      }

      .toggle-button-group {
        display: flex;
        width: 100%;
        box-shadow: var(--shadow-button);
        border-radius: 5px;
        overflow: hidden;
      }
      .toggle-button {
        margin: 0;
        flex-grow: 1;
        flex-basis: 0;
        width: auto;
        border: none;
        border-right: 1px solid var(--accent-secondary);
        border-radius: 0;
        box-shadow: none;
        font-size: 18px;
        padding: 12px 8px;
      }
      .toggle-button:not(.active) {
        background-image: var(--gradient-button-subtle);
      }
      .toggle-button:last-child {
        border-right: none;
      }
      .toggle-button.active {
        background-color: var(--toggle-button-active-bg);
        background-image: var(--gradient-accent-button);
        color: var(--toggle-button-active-text);
        border-color: var(--toggle-button-active-border);
        font-weight: bold;
        box-shadow: var(--shadow-toggle-active-inset);
      }

      .value-selector {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .value-selector-buttons {
        display: flex;
        width: 100%;
        gap: 8px;
      }
      .value-selector-buttons .button {
        flex-grow: 1;
        flex-basis: 0;
        font-size: 22px;
        padding: 16px 8px;
        margin: 0;
      }
      .value-selector-display {
        width: 100%;
        text-align: center;
        font-size: 22px;
        font-weight: bold;
        color: var(--text-primary);
        background-color: var(--dro-bg);
        padding: 12px 10px; /* Your existing padding */
        border-radius: 6px;
        border: 1px solid var(--border-color-medium);
        box-sizing: border-box; /* Height includes padding and border */
        box-shadow: var(--shadow-dro-inset);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        white-space: nowrap;

        /* === MODIFIED STYLES === */
        min-height: 75px; /* New desired height */
        height: 75px; /* New desired height */
        /* line-height: 51px;    You can remove or comment out the original line-height, 
                               as flexbox (align-items: center) handles vertical centering. */

        /* Add negative margin-bottom to compensate for the height increase (75px new - 51px old = 24px) */
        margin-bottom: -24px;
        /* === END OF MODIFICATIONS === */
      }

      .action-button {
        padding: 14px;
        font-size: 19px;
        font-weight: bold;
        text-shadow: 0 1px 1px rgba(0, 0, 0, 0.25);
      }
      .action-button.set-button {
        background-color: var(--indicator-blue-bg);
        background-image: var(--gradient-accent-button);
        color: var(--text-on-accent);
        border-color: var(--toggle-button-active-border);
      }
      .jog-button {
        background-color: var(--indicator-jog-bg);
        background-image: var(--gradient-action-button);
        color: var(--text-on-indicator-light-bg);
        font-size: 22px;
        padding: 12px 10px;
      }
      .jog-button:hover {
        filter: brightness(1.1);
      }
      .start-button {
        background-color: var(--indicator-green-bg);
        background-image: var(--gradient-action-button);
        color: var(--text-on-indicator-dark-bg);
      }
      .start-button:hover {
        filter: brightness(1.1);
      }
      .stop-button {
        background-color: var(--indicator-red-bg);
        background-image: var(--gradient-action-button);
        color: var(--text-on-indicator-dark-bg);
      }
      .stop-button:hover {
        filter: brightness(1.1);
      }
      #semiauto-stop-setup-controls .set-button {
        background-color: var(--indicator-blue-bg);
        background-image: var(--gradient-accent-button);
        color: var(--text-on-accent);
        border-color: var(--toggle-button-active-border);
      }
      #semiauto-stop-setup-controls .set-button:hover {
        filter: brightness(1.1);
      }

      .direction-controls {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-bottom: 8px;
        width: 100%;
      }
      .direction-controls .button {
        margin: 0;
        width: 100%;
        font-size: 19px;
        padding: 14px 10px;
      }
      .direction-controls .button.active-direction {
        background-color: var(--indicator-blue-bg);
        background-image: var(--gradient-accent-button);
        color: var(--text-on-accent);
        border-color: var(--toggle-button-active-border);
        box-shadow: var(--shadow-button-active);
      }

      .status-indicator {
        padding: 10px;
        margin-top: 12px;
        border-radius: 6px;
        text-align: center;
        font-weight: 600;
        font-size: 18px;
        flex-shrink: 0;
        width: 100%;
        box-sizing: border-box;
        box-shadow: var(--shadow-button);
      }
      .status-manual {
        background-color: var(--status-manual-bg);
        color: var(--status-manual-text-color);
        background-image: var(--gradient-button-subtle);
      }
      .status-semiauto {
        background-color: var(--status-semiauto-bg);
        color: var(--text-on-indicator-dark-bg);
        background-image: var(--gradient-action-button);
      }
      .status-jog {
        background-color: var(--status-jog-bg);
        color: var(--text-on-indicator-light-bg);
        background-image: var(--gradient-action-button);
      }

      hr {
        border-color: var(--border-color-dark);
        margin: 15px 0;
        border-style: solid;
        border-width: 1px 0 0 0;
      }
      #semiauto-stop-setup-controls hr {
        margin: 10px 0;
      }
      #semiauto-stop-setup-controls > label[for="semiauto-stop-z"] {
        font-size: 17px;
        margin-bottom: 5px;
        color: var(--text-secondary);
      }
      #semiauto-stop-setup-controls .feed-rate-inputs {
        margin-bottom: 6px;
      }
      #semiauto-stop-setup-controls .button {
        padding: 7px 8px;
        font-size: 15px;
        margin-top: 6px;
        margin-bottom: 0;
      }
      #semiauto-stop-setup-controls .button:last-of-type {
        margin-bottom: 2px;
      }

      #feed-mode-controls-group,
      #jog-mode-controls-group,
      #semiauto-specific-controls-group {
        display: flex;
        flex-direction: column;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div class="screen-container" id="els-screen">
      <div class="tabs">
        <div class="tab-button active" id="tab-turning">TURNING</div>
        <div class="tab-button" id="tab-threading">THREADING</div>
        <div class="tab-button" id="tab-setup">SETUP</div>
      </div>

      <div class="content-area">
        <div class="content-block column-position-speed">
          <div class="block-title">POSITION & SPEED</div>
          <div class="control-group rpm-display-container">
            <div class="dro-label">Spindle RPM:</div>
            <div class="dro-display" id="rpm-display"></div>
          </div>
          <div class="control-group">
            <div class="dro-label" id="z-axis-main-label">
              Z-Position (ELS):
            </div>
            <div class="dro-display" id="z-axis-display"></div>
            <button
              class="button action-button set-button"
              id="button-zero-carriage"
              onclick="zeroZAxis()"
            >
              Zero Carriage
            </button>
            <div class="info-note">
              <div class="info-note-label">NOTE</div>
              <div class="info-note-content">
                Engage half-nuts for ELS-driven carriage movement.
              </div>
            </div>
          </div>
        </div>

        <div class="content-block column-feed-mode">
          <div class="block-title">FEED & MODE</div>
          <div class="control-group">
            <label>Feed Unit:</label>
            <div class="toggle-button-group">
              <button
                class="toggle-button active"
                id="unit-metric"
                onclick="selectUnit('metric')"
              >
                mm/rev
              </button>
              <button
                class="toggle-button"
                id="unit-imperial"
                onclick="selectUnit('imperial')"
              >
                inch/rev
              </button>
            </div>
          </div>
          <div class="control-group">
            <label>Standard Feed Rate:</label>
            <div class="value-selector">
              <div class="value-selector-buttons">
                <button
                  class="button"
                  id="button-prev-feedrate"
                  onclick="changeStandardFeed(-1)"
                >
                  PREV
                </button>
                <button
                  class="button"
                  id="button-next-feedrate"
                  onclick="changeStandardFeed(1)"
                >
                  NEXT
                </button>
              </div>
              <div
                class="value-selector-display"
                id="current-feedrate-display"
              ></div>
            </div>
          </div>
          <hr />
          <div class="control-group">
            <label>Operating Mode:</label>
            <div class="toggle-button-group">
              <button
                class="toggle-button active"
                id="mode-manual"
                onclick="selectMode('manual')"
              >
                Manual
              </button>
              <button
                class="toggle-button"
                id="mode-semiauto"
                onclick="selectMode('semiauto')"
              >
                Semi-Auto
              </button>
              <button
                class="toggle-button"
                id="mode-jog"
                onclick="selectMode('jog')"
              >
                Jog
              </button>
            </div>
            <div class="status-indicator status-manual" id="mode-status">
              Mode: Manual
            </div>
          </div>
        </div>

        <div class="content-block column-controls">
          <div class="block-title">CARRIAGE CONTROLS</div>
          <div id="feed-mode-controls-group">
            <div
              class="control-group"
              id="general-direction-controls-container"
            >
              <label>Carriage Direction:</label>
              <div class="direction-controls">
                <button
                  class="button"
                  id="button-z-dir-towards"
                  onclick="setZDirection('towards')"
                >
                  ← Towards
                </button>
                <button
                  class="button"
                  id="button-z-dir-away"
                  onclick="setZDirection('away')"
                >
                  Away →
                </button>
              </div>
            </div>
            <div class="control-group" id="feed-action-buttons-container">
              <button
                class="button action-button start-button"
                id="button-start-feed"
                onclick="startFeed()"
              >
                START FEED
              </button>
              <button
                class="button action-button stop-button"
                id="button-stop-feed"
                onclick="stopFeed()"
              >
                STOP FEED
              </button>
            </div>
          </div>
          <div id="semiauto-specific-controls-group" style="display: none">
            <div id="semiauto-stop-setup-controls">
              <hr />
              <label for="semiauto-stop-z"
                >Semi-Auto Stop (<span id="semiauto-unit-label">mm</span
                >):</label
              >
              <div class="feed-rate-inputs">
                <input
                  type="number"
                  id="semiauto-stop-z"
                  step="0.001"
                  placeholder="Enter stop"
                />
              </div>
              <button
                class="button set-button"
                id="button-set-semiauto-stop"
                onclick="setSemiAutoStop()"
              >
                Set Stop
              </button>
              <button
                class="button"
                id="button-use-current-z-as-stop"
                onclick="useCurrentZAsStop()"
              >
                Use Current Z
              </button>
            </div>
          </div>
          <div id="jog-mode-controls-group" style="display: none">
            <div class="control-group" id="jog-action-buttons-container">
              <button
                class="button action-button jog-button"
                id="button-jog-left"
                onclick="jogCommand('left')"
              >
                ᐊ JOG LEFT
              </button>
              <button
                class="button action-button jog-button"
                id="button-jog-right"
                onclick="jogCommand('right')"
              >
                JOG RIGHT ᐅ
              </button>
            </div>
            <div class="control-group" id="jog-speed-selector-group">
              <label id="jog-speed-selector-label">Jog Speed:</label>
              <div class="value-selector">
                <div class="value-selector-buttons">
                  <button
                    class="button"
                    id="button-prev-jog-speed"
                    onclick="changeJogSpeed(-1)"
                  >
                    PREV
                  </button>
                  <button
                    class="button"
                    id="button-next-jog-speed"
                    onclick="changeJogSpeed(1)"
                  >
                    NEXT
                  </button>
                </div>
                <div
                  class="value-selector-display"
                  id="current-jog-speed-display"
                >
                  -- Unit --
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let currentZPosition = null,
        currentRPM = null,
        currentFeedUnit = "metric",
        currentMode = "manual",
        zDirection = "",
        semiAutoStopZ = null,
        isFeedActive = false,
        currentStandardFeedIndex = -1,
        activeFeedRateValue = null,
        currentJogSpeedIndex = 0,
        activeJogSpeedValue = 0;

      const metricFeedRates = [
          { text: "Fine (0.05)", value: 0.05 },
          { text: "Gen (0.10)", value: 0.1 },
          { text: "Med (0.15)", value: 0.15 },
          { text: "Coarse (0.25)", value: 0.25 },
          { text: "Rough (0.40)", value: 0.4 },
        ],
        imperialFeedRates = [
          { text: "Fine (0.002)", value: 0.002 },
          { text: "Gen (0.004)", value: 0.004 },
          { text: "Med (0.006)", value: 0.006 },
          { text: "Coarse (0.010)", value: 0.01 },
          { text: "Rough (0.015)", value: 0.015 },
        ],
        metricJogSpeeds = [
          { text: "Slow (50 mm/min)", value: 50 },
          { text: "Medium (150 mm/min)", value: 150 },
          { text: "Fast (500 mm/min)", value: 500 },
          { text: "Rapid (1000 mm/min)", value: 1000 },
        ],
        imperialJogSpeeds = [
          { text: "Slow (2 in/min)", value: 2 },
          { text: "Medium (6 in/min)", value: 6 },
          { text: "Fast (20 in/min)", value: 20 },
          { text: "Rapid (40 in/min)", value: 40 },
        ];

      const zDisplay = document.getElementById("z-axis-display"),
        rpmDisplay = document.getElementById("rpm-display"),
        currentFeedrateTextDisplay = document.getElementById(
          "current-feedrate-display"
        ),
        modeStatusDisplay = document.getElementById("mode-status"),
        unitMetricButton = document.getElementById("unit-metric"),
        unitImperialButton = document.getElementById("unit-imperial"),
        modeManualButton = document.getElementById("mode-manual"),
        modeSemiautoButton = document.getElementById("mode-semiauto"),
        modeJogButton = document.getElementById("mode-jog"),
        zDirTowardsButton = document.getElementById("button-z-dir-towards"),
        zDirAwayButton = document.getElementById("button-z-dir-away"),
        semiautoStopZInput = document.getElementById("semiauto-stop-z"),
        semiautoUnitLabel = document.getElementById("semiauto-unit-label"),
        currentJogSpeedDisplay = document.getElementById(
          "current-jog-speed-display"
        ),
        feedModeControlsGroup = document.getElementById(
          "feed-mode-controls-group"
        ),
        jogModeControlsGroup = document.getElementById(
          "jog-mode-controls-group"
        ),
        semiautoSpecificControlsGroup = document.getElementById(
          "semiauto-specific-controls-group"
        );

      function updateUIDisplays() {
        zDisplay.textContent =
          currentZPosition !== null ? currentZPosition.toFixed(3) : "";
        rpmDisplay.textContent = currentRPM !== null ? currentRPM : "";

        if (
          semiautoUnitLabel &&
          semiautoSpecificControlsGroup.style.display !== "none"
        ) {
          semiautoUnitLabel.textContent =
            currentFeedUnit === "metric" ? "mm" : "in";
        }

        zDirTowardsButton.classList.remove("active-direction");
        zDirAwayButton.classList.remove("active-direction");
        if (feedModeControlsGroup.style.display !== "none") {
          if (zDirection === "towards") {
            zDirTowardsButton.classList.add("active-direction");
          } else if (zDirection === "away") {
            zDirAwayButton.classList.add("active-direction");
          }
        }
        updateStandardFeedDisplay();
        updateJogSpeedDisplay();
      }

      function updateStandardFeedDisplay() {
        const rates =
          currentFeedUnit === "metric" ? metricFeedRates : imperialFeedRates;
        if (currentStandardFeedIndex === -1 || rates.length === 0) {
          currentFeedrateTextDisplay.textContent = "";
          activeFeedRateValue = null;
        } else if (rates[currentStandardFeedIndex]) {
          currentFeedrateTextDisplay.textContent =
            rates[currentStandardFeedIndex].text;
          activeFeedRateValue = rates[currentStandardFeedIndex].value;
        } else {
          currentStandardFeedIndex = -1;
          currentFeedrateTextDisplay.textContent = "";
          activeFeedRateValue = null;
        }
      }

      function changeStandardFeed(direction) {
        const rates =
          currentFeedUnit === "metric" ? metricFeedRates : imperialFeedRates;
        if (rates.length === 0) return;
        if (currentStandardFeedIndex === -1) {
          currentStandardFeedIndex = direction > 0 ? 0 : rates.length - 1;
        } else {
          currentStandardFeedIndex += direction;
          if (currentStandardFeedIndex < 0) {
            currentStandardFeedIndex = rates.length - 1;
          } else if (currentStandardFeedIndex >= rates.length) {
            currentStandardFeedIndex = 0;
          }
        }
        updateStandardFeedDisplay();
      }

      function updateJogSpeedDisplay() {
        const speeds =
          currentFeedUnit === "metric" ? metricJogSpeeds : imperialJogSpeeds;
        const unitSuffix = currentFeedUnit === "metric" ? "mm/min" : "in/min";
        if (speeds.length > 0 && speeds[currentJogSpeedIndex]) {
          activeJogSpeedValue = speeds[currentJogSpeedIndex].value;
          currentJogSpeedDisplay.textContent = `${activeJogSpeedValue} ${unitSuffix}`;
        } else if (speeds.length > 0) {
          currentJogSpeedIndex = 0;
          if (speeds[currentJogSpeedIndex]) {
            activeJogSpeedValue = speeds[currentJogSpeedIndex].value;
            currentJogSpeedDisplay.textContent = `${activeJogSpeedValue} ${unitSuffix}`;
          } else {
            currentJogSpeedDisplay.textContent = "-- Err --";
            activeJogSpeedValue = 0;
          }
        } else {
          currentJogSpeedDisplay.textContent = "-- N/A --";
          activeJogSpeedValue = 0;
        }
      }

      function changeJogSpeed(direction) {
        const speeds =
          currentFeedUnit === "metric" ? metricJogSpeeds : imperialJogSpeeds;
        if (speeds.length === 0) return;
        currentJogSpeedIndex += direction;
        if (currentJogSpeedIndex < 0) {
          currentJogSpeedIndex = speeds.length - 1;
        } else if (currentJogSpeedIndex >= speeds.length) {
          currentJogSpeedIndex = 0;
        }
        updateJogSpeedDisplay();
      }

      function selectUnit(unit) {
        currentFeedUnit = unit;
        unitMetricButton.classList.toggle("active", unit === "metric");
        unitImperialButton.classList.toggle("active", unit === "imperial");
        currentStandardFeedIndex = -1;
        currentJogSpeedIndex = 0;
        if (semiautoStopZInput) semiautoStopZInput.value = "";
        semiAutoStopZ = null;
        updateStandardFeedDisplay();
        updateJogSpeedDisplay();
        updateUIDisplays();
      }

      function selectMode(mode) {
        currentMode = mode;
        modeManualButton.classList.toggle("active", mode === "manual");
        modeSemiautoButton.classList.toggle("active", mode === "semiauto");
        modeJogButton.classList.toggle("active", mode === "jog");
        feedModeControlsGroup.style.display =
          mode === "manual" || mode === "semiauto" ? "flex" : "none";
        jogModeControlsGroup.style.display = mode === "jog" ? "flex" : "none";
        semiautoSpecificControlsGroup.style.display =
          mode === "semiauto" ? "flex" : "none";
        if (mode !== "manual" && mode !== "semiauto") stopFeed();
        if (mode === "manual") isFeedActive = false;
        let statusText = mode.charAt(0).toUpperCase() + mode.slice(1);
        if (mode === "semiauto") statusText = "Semi-Auto";
        modeStatusDisplay.textContent = `Mode: ${statusText}`;
        modeStatusDisplay.className = `status-indicator status-${mode.toLowerCase()}`;
        zDirection = "";
        updateUIDisplays();
      }

      function setZDirection(direction) {
        if (currentMode === "jog") return;
        if (zDirection === direction) zDirection = "";
        else zDirection = direction;
        updateUIDisplays();
      }

      function startFeed() {
        if (currentMode === "jog") return;
        if (!zDirection)
          return alert("Please select a carriage direction first.");
        if (
          activeFeedRateValue === null ||
          isNaN(activeFeedRateValue) ||
          activeFeedRateValue <= 0
        )
          return alert("Please select a valid standard feed rate first.");
        isFeedActive = true;
        const feedUnitText = currentFeedUnit === "metric" ? "mm/rev" : "in/rev";
        if (currentMode === "manual")
          console.log(
            `MANUAL: Starting Feed. Direction: ${zDirection}, Feed Rate: ${activeFeedRateValue} ${feedUnitText}`
          );
        else if (currentMode === "semiauto") {
          if (semiAutoStopZ === null) {
            isFeedActive = false;
            return alert("Please set a Semi-Auto stop position first.");
          }
          console.log(
            `SEMI-AUTO: Starting Feed. Target Z: ${semiAutoStopZ}, Direction: ${zDirection}, Feed Rate: ${activeFeedRateValue} ${feedUnitText}`
          );
        }
      }

      function stopFeed() {
        if (currentMode !== "jog" && isFeedActive) {
          isFeedActive = false;
          console.log(`FEED STOPPED (Mode: ${currentMode})`);
        }
      }

      function jogCommand(direction) {
        if (currentMode !== "jog") return;
        if (isNaN(activeJogSpeedValue) || activeJogSpeedValue <= 0)
          return alert("Please select a valid jog speed first.");
        const speedUnitText =
          currentFeedUnit === "metric" ? "mm/min" : "in/min";
        console.log(
          `JOG Command: Direction: ${direction}, Speed: ${activeJogSpeedValue} ${speedUnitText}`
        );
      }

      function zeroZAxis() {
        currentZPosition = 0;
        updateUIDisplays();
        console.log("Z-Axis Zeroed");
      }

      function setSemiAutoStop() {
        if (!semiautoStopZInput) return;
        const stopValue = parseFloat(semiautoStopZInput.value);
        const unitLabel = currentFeedUnit === "metric" ? "mm" : "in";
        if (isNaN(stopValue)) {
          alert("Invalid stop value entered. Please enter a number.");
          semiautoStopZInput.value = "";
          semiAutoStopZ = null;
        } else {
          semiAutoStopZ = stopValue;
          alert(
            `Semi-Auto stop position set to: ${semiAutoStopZ.toFixed(
              3
            )} ${unitLabel}`
          );
          console.log(`Semi-Auto Stop Set: ${semiAutoStopZ} ${unitLabel}`);
        }
      }

      function useCurrentZAsStop() {
        if (!semiautoStopZInput) return;
        if (currentZPosition === null)
          return alert("Current Z position is not available.");
        semiAutoStopZ = currentZPosition;
        semiautoStopZInput.value = currentZPosition.toFixed(3);
        const unitLabel = currentFeedUnit === "metric" ? "mm" : "in";
        alert(
          `Semi-Auto stop position set to current Z: ${semiAutoStopZ.toFixed(
            3
          )} ${unitLabel}`
        );
        console.log(
          `Semi-Auto Stop Set to Current Z: ${semiAutoStopZ} ${unitLabel}`
        );
      }

      window.onload = () => {
        selectUnit("metric");
        selectMode("manual");
        updateUIDisplays();
      };
    </script>
  </body>
</html>
